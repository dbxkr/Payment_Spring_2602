<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²°ì œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f4f4f4; }
        .container { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, select:focus { border-color: #007bff; outline: none; }
        button { width: 100%; padding: 14px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: bold; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        #result { margin-top: 25px; background: #2d2d2d; color: #fff; padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: 'Consolas', monospace; font-size: 14px; line-height: 1.5; }
        .error { color: #ff6b6b; font-weight: bold; }
        .badge { background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ’³ ê²°ì œ í‚¤ì˜¤ìŠ¤í¬</h2>
    
    <div class="form-group">
        <label for="memberSelect">íšŒì› ì„ íƒ (í…ŒìŠ¤íŠ¸ ê³„ì •)</label>
        <select id="memberSelect">
            <option value="" disabled selected>â³ íšŒì› ëª©ë¡ ë¡œë”© ì¤‘...</option>
        </select>
    </div>

    <div class="form-group">
        <label>ìƒí’ˆëª…</label>
        <input type="text" id="itemName" value="RTX 5090" placeholder="ìƒí’ˆëª…">
    </div>

    <div class="form-group">
        <label>ê°€ê²© (ì›)</label>
        <input type="number" id="itemPrice" value="10050" placeholder="ê°€ê²©">
    </div>

    <div class="form-group">
        <label>ê²°ì œ ìˆ˜ë‹¨</label>
        <select id="paymentMethod">
            <option value="CREDIT_CARD">ğŸ’³ ì‹ ìš©ì¹´ë“œ (ê¸°ë³¸)</option>
            <option value="POINT" selected>ğŸ…¿ï¸ í¬ì¸íŠ¸ (5% ì¶”ê°€í• ì¸)</option>
        </select>
    </div>

    <button onclick="order()">ê²°ì œí•˜ê¸°</button>

    <div id="result" style="display:none;"></div>
</div>

<script>
    // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ íšŒì› ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', async () => {
        const memberSelect = document.getElementById('memberSelect');
        
        try {
            const response = await fetch('/api/orders/testmembers'); 
            
            if (!response.ok) throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨ (${response.status})`);
            
            const members = await response.json();
            
            // ê¸°ì¡´ ì˜µì…˜ ë¹„ìš°ê¸°
            memberSelect.innerHTML = '';
            
            if (members.length === 0) {
                memberSelect.innerHTML = '<option disabled>ì¡°íšŒëœ í…ŒìŠ¤íŠ¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</option>';
                return;
            }

            // ë°›ì•„ì˜¨ íšŒì›ë“¤ë¡œ ì˜µì…˜ ì±„ìš°ê¸°
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id; 
                option.textContent = `${member.name} (${member.grade})`; 
                memberSelect.appendChild(option);
            });
            
            // ì²« ë²ˆì§¸ íšŒì› ìë™ ì„ íƒ
            memberSelect.selectedIndex = 0;

        } catch (error) {
            console.error('íšŒì› ëª©ë¡ ë¡œë”© ì—ëŸ¬:', error);
            memberSelect.innerHTML = '<option disabled selected>âŒ íšŒì› ëª©ë¡ ë¡œë”© ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)</option>';
            document.getElementById('result').style.display = 'block';
            document.getElementById('result').innerHTML = `<span class="error">ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${error.message}<br>@Profile("local") ì„¤ì •ì´ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</span>`;
        }
    });

    // 2. ì£¼ë¬¸ ìš”ì²­ í•¨ìˆ˜
    async function order() {
        const memberId = document.getElementById('memberSelect').value;
        const resultDiv = document.getElementById('result');

        if (!memberId) {
            alert("íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
            return;
        }

        const data = {
            memberId: memberId,
            itemName: document.getElementById('itemName').value,
            itemPrice: document.getElementById('itemPrice').value,
            paymentMethod: document.getElementById('paymentMethod').value
        };

        resultDiv.style.display = 'block';
        resultDiv.innerHTML = 'â³ ê²°ì œ ì²˜ë¦¬ ì¤‘...';

        try {
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorText = await response.text(); // ì„œë²„ ì—ëŸ¬ ë©”ì‹œì§€ ì½ê¸°
                throw new Error(errorText || 'ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');
            }

            const order = await response.json();
            
            // ì˜ìˆ˜ì¦ ì¶œë ¥
            let html = `<strong>âœ… ì£¼ë¬¸ ì„±ê³µ! (Order ID: ${order.id})</strong>\n`;
            html += `------------------------------------------\n`;
            html += `ìƒí’ˆëª…   : ${order.itemName}\n`;
            html += `ì£¼ë¬¸ê¸ˆì•¡ : ${Number(order.itemPrice).toLocaleString()}ì›\n`;
            html += `í• ì¸ê¸ˆì•¡ : <span style="color:#ff6b6b">-${Number(order.discountPrice).toLocaleString()}ì›</span>\n`;
            html += `ìµœì¢…ê²°ì œ : <strong>${Number(order.itemPrice - order.discountPrice).toLocaleString()}ì›</strong>\n`;
            html += `------------------------------------------\n`;
            html += `[í• ì¸ ìƒì„¸ ë‚´ì—­]\n`;
            
            if (order.discountRecords && order.discountRecords.length > 0) {
                order.discountRecords.forEach(record => {
                    html += `- ${record.policyName}: ${Number(record.discountAmount).toLocaleString()}ì›\n`;
                });
            } else {
                html += `- ì ìš©ëœ í• ì¸ ì—†ìŒ\n`;
            }

            resultDiv.innerHTML = html;

        } catch (error) {
            resultDiv.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</span>`;
        }
    }
</script>

</body>
</html>